<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Star-Hub">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Spielesucher mit Einstellungen, Favoriten, Musik & Fullscreen</title>
  <!-- Externe CSS-Datei -->
  <link rel="stylesheet" href="styles.css">
  <!-- JSZip (zum Verarbeiten von ZIP-Dateien) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
</head>
<body>
  <!-- Header "Star-hub" – wird nach dem Upload ausgeblendet -->
  <div id="main-header">Star-hub</div>
  <div class="container">
    <div class="content" id="main-content">
      <!-- Statt eines Ordner-Auswahl-Buttons: ZIP-Datei hochladen -->
      <input type="file" id="zip-input" accept=".zip">
      <!-- Einstellungen-Button -->
      <button id="settings-button">Einstellungen</button>
      <!-- Hier werden die Spiele (Favoriten, Superprogramme, normale Spiele, 3rd Party Games) aufgelistet -->
      <ul id="program-list"></ul>
      <!-- Audio-Player (wird unsichtbar verwendet) -->
      <audio id="audio-player"></audio>
    </div>
    <!-- Footer (Status-Bar) – zeigt z. B. "Star-tools a @wolfikuproduction | version : [Name]" -->
    <footer id="folder-info"></footer>
  </div>
  
  <!-- Fullscreen-Container für die Spielanzeige -->
  <div id="fullscreen-container">
    <iframe id="fullscreen-iframe"></iframe>
    <button id="exit-fullscreen">Stop</button>
  </div>
  
  <!-- Modal für Einstellungen -->
  <div id="settings-modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2>Einstellungen</h2>
      <div class="settings-group">
        <label for="sorting-option">Sortierung:</label>
        <select id="sorting-option">
          <option value="default">Standard</option>
          <option value="alphabetical">Alphabetisch</option>
        </select>
      </div>
      <div class="settings-group">
        <label for="music-volume">Musiklautstärke:</label>
        <input type="range" id="music-volume" min="0" max="1" step="0.01" value="0.5">
      </div>
      <div class="settings-group">
        <button id="delete-all-data">Alle Daten löschen</button>
      </div>
    </div>
  </div>
  
  <!-- Service Worker Registrierung -->
  <script>
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js")
            .then(() => console.log("Service Worker registriert"))
            .catch((err) => console.log("Service Worker Fehler:", err));
    }
  </script>
  
  <!-- Haupt-Script -->
  <script>
    /* 
      Dieser Code übernimmt alle Funktionen des vorherigen Skripts (Favoriten, Einstellungen,
      Vollbildmodus, Musik, etc.) – nur dass nun anstatt eines Ordner-Auswahl-Dialogs
      eine ZIP-Datei hochgeladen wird. Die ZIP-Datei muss die gesamte Ordnerstruktur enthalten,
      z. B.:
      
      - sh-data/
         - 1/
           - sshtml_xyz/ (enthält game-data/ und media-data/)
           - weitere HTML-Dateien
         - 2/ usw.
      - sh-3party-games/
         - Dateien (HTML)
    */
    
    // Globaler JSZip-Container
    let globalZip = null;

    // ZIP-Upload: Sobald eine ZIP-Datei hochgeladen wird, wird sie verarbeitet.
    document.getElementById("zip-input").addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const jszip = new JSZip();
      try {
        globalZip = await jszip.loadAsync(file);
      } catch (e) {
        alert("Fehler beim Laden der ZIP-Datei: " + e.message);
        return;
      }
      // Nach erfolgreichem Upload:
      document.getElementById("zip-input").style.display = "none";
      document.getElementById("main-header").style.display = "none";
      
      // Ermittele den neuesten Unterordner in "sh-data/"
      const newest = getNewestSubfolderFromZip(globalZip);
      if (!newest) {
        alert("Kein passender Unterordner in 'sh-data' gefunden.");
        return;
      }
      // Setze die Version im Footer: "Star-tools a @wolfikuproduction | version : [Neuster Ordner]"
      document.getElementById("folder-info").textContent = "Star-tools a @wolfikuproduction | version : " + newest;
      // Liste die Programme und 3rd Party Games aus dem ZIP auf
      await listProgramsFromZip(newest);
      await listThirdPartyGamesFromZip();
    });

    // Funktion: Ermittelt den höchsten (neuesten) Ordner in "sh-data/"
    function getNewestSubfolderFromZip(zip) {
      let max = -1;
      let chosen = null;
      for (const key in zip.files) {
        if (key.startsWith("sh-data/")) {
          const parts = key.split("/");
          if (parts.length >= 2) {
            const num = parseInt(parts[1]);
            if (!isNaN(num) && num > max) {
              max = num;
              chosen = parts[1];
            }
          }
        }
      }
      return chosen;
    }

    // Funktion: Liste der Programme (Superprogramme und normale Spiele) aus dem neuesten Ordner
    async function listProgramsFromZip(folder) {
      const programListElem = document.getElementById("program-list");
      const prefix = "sh-data/" + folder + "/";
      const superPrograms = [];
      const normalFiles = [];
      
      for (const key in globalZip.files) {
        if (key.startsWith(prefix)) {
          const relative = key.substring(prefix.length);
          // Überspringe Verzeichnisse
          if (globalZip.files[key].dir) continue;
          // Superprogramme: Erkennung, wenn der Pfad mit "sshtml_" beginnt
          if (relative.startsWith("sshtml_")) {
            // Beispielpfad: "sshtml_xyz/game-data/game.html"
            const parts = relative.split("/");
            if (parts.length >= 2) {
              const title = parts[0].replace("sshtml_", "");
              superPrograms.push({ title: title, filePath: key });
            }
          } else if (relative.endsWith(".html")) {
            normalFiles.push({ title: relative.replace(/\.html$/i, ""), filePath: key });
          }
        }
      }
      
      // Zeige Superprogramme an
      for (const sp of superPrograms) {
        const li = document.createElement("li");
        li.className = "super-program";
        li.textContent = sp.title;
        li.onclick = async () => {
          try {
            const blob = await globalZip.file(sp.filePath).async("blob");
            const url = URL.createObjectURL(blob);
            await enterFullscreen(url);
            // Hier könntest du auch Musik aus dem entsprechenden media-data-Ordner starten
          } catch (err) {
            alert("Das Spiel konnte nicht geladen werden.");
          }
        };
        programListElem.appendChild(li);
      }
      
      if (superPrograms.length > 0 && normalFiles.length > 0) {
        const separator = document.createElement("li");
        separator.textContent = "----- Normale Spiele -----";
        separator.style.textAlign = "center";
        separator.style.fontStyle = "italic";
        programListElem.appendChild(separator);
      }
      
      // Zeige normale HTML-Dateien an
      for (const nf of normalFiles) {
        const li = document.createElement("li");
        li.className = "normal-program";
        li.textContent = nf.title;
        li.onclick = async () => {
          try {
            const blob = await globalZip.file(nf.filePath).async("blob");
            const url = URL.createObjectURL(blob);
            await enterFullscreen(url);
          } catch (err) {
            alert("Das Spiel konnte nicht geladen werden.");
          }
        };
        programListElem.appendChild(li);
      }
    }

    // Funktion: Liste 3rd Party Games aus "sh-3party-games/"
    async function listThirdPartyGamesFromZip() {
      const prefix = "sh-3party-games/";
      const entries = [];
      for (const key in globalZip.files) {
        if (key.startsWith(prefix) && !globalZip.files[key].dir && key.endsWith(".html")) {
          entries.push({ title: key.substring(prefix.length).replace(/\.html$/i, ""), filePath: key });
        }
      }
      if (entries.length > 0) {
        const programListElem = document.getElementById("program-list");
        const separator = document.createElement("li");
        separator.textContent = "----- 3rd Party Games -----";
        separator.style.textAlign = "center";
        separator.style.fontStyle = "italic";
        programListElem.appendChild(separator);
        for (const entry of entries) {
          const li = document.createElement("li");
          li.className = "third-party-program";
          li.textContent = entry.title;
          li.onclick = async () => {
            try {
              const blob = await globalZip.file(entry.filePath).async("blob");
              const url = URL.createObjectURL(blob);
              await enterFullscreen(url);
            } catch (err) {
              alert("Das Spiel konnte nicht geladen werden.");
            }
          };
          programListElem.appendChild(li);
        }
      }
    }

    // Vollbild-Funktion: Öffnet die URL im Iframe im Vollbildmodus
    async function enterFullscreen(url) {
      const fsContainer = document.getElementById("fullscreen-container");
      const fsIframe = document.getElementById("fullscreen-iframe");
      fsIframe.src = url;
      fsContainer.style.display = "block";
      if (fsContainer.requestFullscreen) {
        await fsContainer.requestFullscreen();
      } else if (fsContainer.webkitRequestFullscreen) {
        await fsContainer.webkitRequestFullscreen();
      } else if (fsContainer.msRequestFullscreen) {
        await fsContainer.msRequestFullscreen();
      }
    }

    document.getElementById("exit-fullscreen").addEventListener("click", async function() {
      if (document.fullscreenElement) {
        await document.exitFullscreen();
      }
      document.getElementById("fullscreen-container").style.display = "none";
    });

    // Einstellungen-Modal
    const settingsButton = document.getElementById("settings-button");
    const settingsModal = document.getElementById("settings-modal");
    const closeModal = document.querySelector(".close-modal");

    settingsButton.addEventListener("click", () => {
      settingsModal.style.display = "block";
    });
    if (closeModal) {
      closeModal.addEventListener("click", () => {
        settingsModal.style.display = "none";
        const sortingOption = document.getElementById("sorting-option").value;
        localStorage.setItem("sortingOption", sortingOption);
        const volume = document.getElementById("music-volume").value;
        document.getElementById("audio-player").volume = volume;
      });
    }
    window.addEventListener("click", (e) => {
      if (e.target === settingsModal) {
        settingsModal.style.display = "none";
        const sortingOption = document.getElementById("sorting-option").value;
        localStorage.setItem("sortingOption", sortingOption);
        const volume = document.getElementById("music-volume").value;
        document.getElementById("audio-player").volume = volume;
      }
    });

    document.getElementById("delete-all-data").addEventListener("click", async () => {
      if (confirm("Alle lokalen Daten (Favoriten, Einstellungen) wirklich löschen?")) {
        localStorage.removeItem("sortingOption");
        await clearAllFavorites();
        alert("Alle Daten wurden gelöscht.");
      }
    });
  </script>
</body>
</html>
